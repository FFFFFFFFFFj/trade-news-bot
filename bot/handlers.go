package bot

import (
	"fmt"
	"log"
	"strings"

	"github.com/FFFFFFFFFFj/trade-news-bot/storage"
	tb "gopkg.in/telebot.v3"
)

var AdminIDs = map[int64]bool{
	839986298: true, // —Ç–≤–æ–π ID
}

func (b *Bot) IsAdmin(userID int64) bool {
	return AdminIDs[userID]
}

func (b *Bot) HandleMessage(m *tb.Message) {
	txt := strings.TrimSpace(m.Text)

	switch {
	case txt == "/start":
		subsCount, _ := storage.GetUserSubscriptionCount(b.db, m.Chat.ID)
		if b.IsAdmin(m.Chat.ID) {
			activeUsers, _ := storage.GetActiveUsersCount(b.db)
			msg := fmt.Sprintf("üëë –ê–¥–º–∏–Ω\nID: %d\n–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: %d\n–í—Å–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: %d", m.Chat.ID, activeUsers, len(storage.MustGetAllSources(b.db)))
			b.SendMessage(m.Chat.ID, msg)
		} else {
			msg := fmt.Sprintf("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\nID: %d\n–ü–æ–¥–ø–∏—Å–æ–∫: %d", m.Chat.ID, subsCount)
			b.SendMessage(m.Chat.ID, msg)
		}

	case txt == "/help":
		b.SendMessage(m.Chat.ID, "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/start\n/help\n/latest\n/mysources")

	case txt == "/latest":
		items, _ := storage.GetUnreadNews(b.db, m.Chat.ID, 5)
		if len(items) == 0 {
			b.SendMessage(m.Chat.ID, "–ù–µ—Ç –Ω–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.")
			return
		}
		for _, item := range items {
			b.SendMessage(m.Chat.ID, fmt.Sprintf("üì∞ %s\nüîó %s", item.Title, item.Link))
			_ = storage.MarkNewsAsRead(b.db, m.Chat.ID, item.Link)
		}

	case txt == "/mysources":
		b.ShowSourcesMenu(m.Chat.ID)

	default:
		log.Printf("–°–æ–æ–±—â–µ–Ω–∏–µ: %s", txt)
	}
}
